#!/usr/bin/env bash
set -euo pipefail

invoke_malware () {
  echo "[Malware] Start"
Malware  
echo "[Malware] Done"
}


Malware() {

# Listening Malware Search
for pid in $(sudo ss -plnt | grep -oP 'pid=\K\d+' | sort -u); do cmdline=$(tr -d '\0' < /proc/$pid/cmdline 2>/dev/null); if [ -n "$cmdline" ]; then echo "PID: $pid - Command Line: $cmdline" >> "$DOCS/postmalware.txt"; fi; done


for pid in $(sudo ss -plnt | grep -oP 'pid=\K\d+' | sort -u); do
    # Get the command line associated with the PID
    cmdline=$(tr '\0' ' ' < /proc/$pid/cmdline 2>/dev/null)
    
    if [ -n "$cmdline" ]; then
		echo ""
        echo "PID: $pid - Command Line: $cmdline"
        
        # Get the executable or script path
        exe_file=$(readlink -f /proc/$pid/exe 2>/dev/null)
        
        if [ -n "$exe_file" ] && [ -f "$exe_file" ]; then
            # Check if the executable is an interpreter (Python, Perl, etc.)
            if [[ "$exe_file" == *python* || "$exe_file" == *perl* || "$exe_file" == *bash* || "$exe_file" == *sh* ]]; then
                # Extract the script file being executed
                script_file=$(echo "$cmdline" | awk '{print $2}')
                
                if [ -n "$script_file" ] && [ -f "$script_file" ]; then
                    echo "Interpreter: $exe_file"
                    echo -e "Script file: ${script_file}${NC}"
                    
                    # Prompt to remove the script file
                    read -p "Do you want to remove this script file? (Y/n) " answer
                    answer=${answer:-Y}
                    
                    if [[ "$answer" == "Y" || "$answer" == "y" ]]; then
                        echo "Removing $script_file..."
                        sudo rm -f "$script_file"
                        
                        if [ $? -eq 0 ]; then
                            echo "File $script_file removed successfully."
                        else
                            echo "Failed to remove $script_file."
                        fi
                    else
                        echo "Skipping removal of $script_file."
                    fi
                else
                    echo "No valid script file found."
                fi
            else
				echo -e "Executable file: ${RED}${exe_file}${NC}"                
                # Prompt to remove the executable
                read -p "Do you want to remove this file? (Y/n) " answer
                answer=${answer:-Y}
                
                if [[ "$answer" == "Y" || "$answer" == "y" ]]; then
                    echo "Removing $exe_file..."
                    sudo rm -f "$exe_file"
                    
                    if [ $? -eq 0 ]; then
                        echo "File $exe_file removed successfully."
                    else
                        echo "Failed to remove $exe_file."
                    fi
                else
                    echo "Skipping removal of $exe_file."
                fi
            fi
        else
            echo "Executable file not found or is not a regular file."
        fi
    fi
done
